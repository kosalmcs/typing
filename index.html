<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typing Speed Test</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the blinking cursor in the text display */
        .highlight-current {
            background-color: #d1fae5; /* Light green for current character */
            border-bottom: 2px solid #10b981; /* Green underline for current character */
            animation: blink-caret 0.75s step-end infinite;
        }

        @keyframes blink-caret {
            from, to { border-color: transparent; }
            50% { border-color: #10b981; }
        }

        /* Style for correct characters */
        .correct {
            color: #10b981; /* Green */
        }

        /* Style for incorrect characters */
        .incorrect {
            color: #ef4444; /* Red */
            background-color: #fee2e2; /* Light red background for errors */
            text-decoration: underline wavy #ef4444; /* Wavy underline for errors */
        }

        /* Custom scrollbar for the text display */
        .text-display::-webkit-scrollbar {
            width: 8px;
        }

        .text-display::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .text-display::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .text-display::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-gradient-to-r from-blue-100 to-purple-100 min-h-screen flex items-center justify-center p-4 font-sans text-gray-800">

    <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 w-full max-w-3xl flex flex-col items-center space-y-6">

        <h1 class="text-4xl font-extrabold text-blue-600 mb-4">Typing Speed Test</h1>

        <!-- Options: Duration Selection, Text Category, Case Sensitivity -->
        <div class="flex flex-wrap justify-center gap-4 mb-4 w-full">
            <div class="flex items-center space-x-2">
                <label for="test-duration" class="text-lg font-semibold text-gray-700">Duration:</label>
                <select id="test-duration" class="p-2 border-2 border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-200">
                    <option value="0">Full Text</option>
                    <option value="30">30 Seconds</option>
                    <option value="60">60 Seconds</option>
                    <option value="120">120 Seconds</option>
                </select>
            </div>

            <div class="flex items-center space-x-2">
                <label for="text-category" class="text-lg font-semibold text-gray-700">Text Category:</label>
                <select id="text-category" class="p-2 border-2 border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-200">
                    <option value="general">General</option>
                    <option value="quotes">Quotes</option>
                    <option value="technical">Technical</option>
                </select>
            </div>

            <div class="flex items-center space-x-2">
                <input type="checkbox" id="case-sensitive" class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500">
                <label for="case-sensitive" class="text-lg font-semibold text-gray-700">Case Sensitive</label>
            </div>
        </div>

        <!-- Text Display Area -->
        <div id="text-display" class="text-display bg-gray-50 p-6 rounded-xl border border-gray-200 text-lg leading-relaxed tracking-wide text-gray-700 w-full min-h-[150px] max-h-[300px] overflow-y-auto resize-y transition-all duration-300 ease-in-out font-mono shadow-inner">
            <span id="typed-text"></span><span id="current-char"></span><span id="remaining-text"></span>
        </div>

        <!-- User Input Area -->
        <textarea
            id="text-input"
            class="w-full p-4 border-2 border-blue-300 rounded-xl focus:outline-none focus:ring-4 focus:ring-blue-200 text-lg font-mono resize-none transition-all duration-300 ease-in-out shadow-md"
            rows="5"
            placeholder="Start typing here..."
            disabled
        ></textarea>

        <!-- Control Buttons -->
        <div class="flex flex-col sm:flex-row gap-4 w-full justify-center">
            <button
                id="start-button"
                class="bg-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 ease-in-out transform hover:scale-105 active:scale-95"
            >
                Start Test
            </button>
            <button
                id="reset-button"
                class="bg-gray-200 text-gray-700 font-bold py-3 px-8 rounded-full shadow-lg hover:bg-gray-300 focus:outline-none focus:ring-4 focus:ring-gray-300 transition-all duration-300 ease-in-out transform hover:scale-105 active:scale-95"
            >
                Reset
            </button>
            <button
                id="print-button"
                class="bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 transition-all duration-300 ease-in-out transform hover:scale-105 active:scale-95"
            >
                Print Results
            </button>
        </div>

        <!-- Results Display -->
        <div class="w-full bg-blue-50 p-6 rounded-xl border border-blue-200 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-3 xl:grid-cols-3 gap-6 text-center shadow-lg">
            <div class="flex flex-col items-center">
                <span class="text-gray-500 text-sm font-semibold">WPM (Words Per Minute)</span>
                <span id="wpm-display" class="text-5xl font-extrabold text-blue-800">0</span>
            </div>
            <div class="flex flex-col items-center">
                <span class="text-gray-500 text-sm font-semibold">Accuracy</span>
                <span id="accuracy-display" class="text-5xl font-extrabold text-purple-800">0%</span>
            </div>
            <div class="flex flex-col items-center">
                <span class="text-gray-500 text-sm font-semibold">Errors</span>
                <span id="errors-display" class="text-5xl font-extrabold text-red-600">0</span>
            </div>
            <div class="flex flex-col items-center">
                <span class="text-gray-500 text-sm font-semibold">Time (seconds)</span>
                <span id="timer-display" class="text-5xl font-extrabold text-green-600">0</span>
            </div>
            <div class="flex flex-col items-center">
                <span class="text-gray-500 text-sm font-semibold">Words Typed</span>
                <span id="words-typed-display" class="text-5xl font-extrabold text-orange-600">0</span>
            </div>
            <div class="flex flex-col items-center">
                <span class="text-gray-500 text-sm font-semibold">Score</span>
                <span id="score-display" class="text-5xl font-extrabold text-indigo-800">0</span>
            </div>
        </div>
    </div>

    <script>
        // Predefined texts categorized by type
        const texts = {
            general: [
                "The quick brown fox jumps over the lazy dog. This is a classic pangram often used for testing typewriters and keyboards.",
                "Never underestimate the power of a good book. Reading can transport you to different worlds and expand your knowledge.",
                "Technology has revolutionized the way we live, work, and interact with each other, connecting people across the globe.",
                "The early bird catches the worm, but the second mouse gets the cheese. Always be prepared for opportunities and challenges.",
                "Practice makes perfect. Consistent effort and dedication are key to mastering any skill, whether it's typing or playing an instrument.",
                "In a world filled with information, critical thinking skills are more important than ever to distinguish fact from fiction.",
                "The ocean is a vast and mysterious place, home to countless species and hidden wonders yet to be fully explored.",
                "Cooking can be a relaxing and rewarding hobby, allowing you to experiment with flavors and create delicious meals.",
                "Artificial intelligence is rapidly advancing, promising transformative changes across various industries and daily life.",
                "The sun always shines brightest after the rain. Overcoming challenges makes successes even more meaningful."
            ],
            quotes: [
                "The only way to do great work is to love what you do. - Steve Jobs",
                "Be the change that you wish to see in the world. - Mahatma Gandhi",
                "The future belongs to those who believe in the beauty of their dreams. - Eleanor Roosevelt",
                "It is during our darkest moments that we must focus to see the light. - Aristotle Onassis",
                "Strive not to be a success, but rather to be of value. - Albert Einstein"
            ],
            technical: [
                "HTTP (Hypertext Transfer Protocol) is the foundation of data communication for the World Wide Web.",
                "JavaScript is a high-level, interpreted scripting language primarily used for client-side web development.",
                "Cascading Style Sheets (CSS) describe how HTML elements are to be displayed on screen.",
                "A git repository is a version control system that tracks changes in source code during software development.",
                "API stands for Application Programming Interface, a set of defined rules that enable applications to interact."
            ]
        };

        // Get references to DOM elements
        const textDisplay = document.getElementById('text-display');
        const typedTextSpan = document.getElementById('typed-text');
        const currentCharSpan = document.getElementById('current-char');
        const remainingTextSpan = document.getElementById('remaining-text');
        const textInput = document.getElementById('text-input');
        const startButton = document.getElementById('start-button');
        const resetButton = document.getElementById('reset-button');
        const printButton = document.getElementById('print-button');
        const wpmDisplay = document.getElementById('wpm-display');
        const accuracyDisplay = document.getElementById('accuracy-display');
        const errorsDisplay = document.getElementById('errors-display');
        const timerDisplay = document.getElementById('timer-display');
        const wordsTypedDisplay = document.getElementById('words-typed-display');
        const scoreDisplay = document.getElementById('score-display');
        const testDurationSelect = document.getElementById('test-duration');
        const textCategorySelect = document.getElementById('text-category');
        const caseSensitiveCheckbox = document.getElementById('case-sensitive'); // New element

        // Game state variables
        let currentText = '';
        let charIndex = 0;
        let startTime = 0;
        let endTime = 0;
        let timerInterval;
        let isTestRunning = false;
        let selectedDuration = 0;
        let wordsTypedCount = 0;
        let typedCharsCorrectness = []; // Stores true/false for correctness of each char at its position
        let isCaseSensitive = false; // New state variable

        // Variables to store final results for printing
        let finalWPM = 0;
        let finalAccuracy = 0;
        let finalErrors = 0;
        let finalTime = 0;
        let finalScore = 0;
        let finalWordsTyped = 0;

        /**
         * Initializes the typing test by setting up the text and resetting game state.
         */
        function initializeTest() {
            const selectedCategory = textCategorySelect.value;
            isCaseSensitive = caseSensitiveCheckbox.checked; // Get initial case sensitivity

            // Ensure duration select is always enabled
            testDurationSelect.disabled = false;

            // Determine which text to use based on the selected category
            const categoryTexts = texts[selectedCategory] || texts.general; // Fallback to general if category not found
            currentText = categoryTexts[Math.floor(Math.random() * categoryTexts.length)];
            
            charIndex = 0;
            startTime = 0;
            endTime = 0;
            isTestRunning = false;
            selectedDuration = parseInt(testDurationSelect.value); 
            wordsTypedCount = 0; // Reset words typed count
            typedCharsCorrectness = new Array(currentText.length).fill(null); // Reset correctness array

            // Clear input and disable it
            textInput.value = '';
            textInput.disabled = true;

            // Clear and reset displays
            clearInterval(timerInterval);
            wpmDisplay.textContent = '0';
            accuracyDisplay.textContent = '0%';
            errorsDisplay.textContent = '0'; // Errors display will be updated at end
            timerDisplay.textContent = '0';
            wordsTypedDisplay.textContent = '0';
            scoreDisplay.textContent = '0';
            startButton.textContent = 'Start Test';
            startButton.disabled = false;
            printButton.disabled = true;

            // Enable options
            testDurationSelect.disabled = false;
            textCategorySelect.disabled = false;
            caseSensitiveCheckbox.disabled = false; // Enable case sensitive checkbox

            // Display the text to be typed, highlighting the first character
            updateTextDisplay();
        }

        /**
         * Updates the visual display of the text, showing typed, current, and remaining parts.
         */
        function updateTextDisplay() {
            // Get the parts of the text: typed, current, and remaining
            const typed = currentText.substring(0, charIndex);
            const current = currentText[charIndex] || ''; // Handle end of text
            const remaining = currentText.substring(charIndex + 1);

            // Apply highlighting for correct/incorrect typed characters
            typedTextSpan.innerHTML = typed.split('').map((expectedChar, i) => {
                let className = '';
                // Only color if typedCharsCorrectness has a value (i.e., not null)
                if (typedCharsCorrectness[i] === true) {
                    className = 'correct';
                } else if (typedCharsCorrectness[i] === false) {
                    className = 'incorrect';
                }
                return `<span class="${className}">${expectedChar}</span>`;
            }).join('');

            // Highlight the current character to be typed
            currentCharSpan.textContent = current;
            if (isTestRunning && current) {
                currentCharSpan.classList.add('highlight-current');
            } else {
                currentCharSpan.classList.remove('highlight-current');
            }

            // Display the remaining text
            remainingTextSpan.textContent = remaining;

            // Scroll the text display to keep the current character in view
            const currentCharElement = currentCharSpan;
            if (currentCharElement) {
                const container = textDisplay;
                const containerRect = container.getBoundingClientRect();
                const charRect = currentCharElement.getBoundingClientRect();

                // Check if the current char is out of view (bottom)
                if (charRect.bottom > containerRect.bottom) {
                    container.scrollTop += (charRect.bottom - containerRect.bottom) + 20;
                }
                // Check if the current char is out of view (top)
                if (charRect.top < containerRect.top) {
                    container.scrollTop -= (containerRect.top - charRect.top) + 20;
                }
            }
        }

        /**
         * Starts the typing test.
         */
        function startTest() {
            if (!currentText || isTestRunning) return;

            isTestRunning = true;
            textInput.disabled = false;
            textInput.focus();
            startTime = new Date().getTime();
            startButton.textContent = 'Typing...';
            startButton.disabled = true;
            printButton.disabled = true;

            // Disable all options during test
            testDurationSelect.disabled = true;
            textCategorySelect.disabled = true;
            caseSensitiveCheckbox.disabled = true; // Disable case sensitive checkbox during test

            // Start the timer
            timerInterval = setInterval(() => {
                const currentTime = new Date().getTime();
                const elapsedSeconds = Math.floor((currentTime - startTime) / 1000);
                timerDisplay.textContent = elapsedSeconds;

                // Check for duration limit if set
                if (selectedDuration > 0 && elapsedSeconds >= selectedDuration) {
                    endTest();
                }
            }, 1000);

            // Update display to show blinking cursor
            updateTextDisplay();
        }

        /**
         * Handles user input from the textarea.
         * @param {Event} event - The input event.
         */
        function handleInput(event) {
            if (!isTestRunning) return;

            // Handle backspace first
            if (event.inputType === 'deleteContentBackward') {
                if (charIndex > 0) {
                    charIndex--;
                    typedCharsCorrectness[charIndex] = null; // Mark backspaced char as untyped
                }
            } else {
                const typedChar = event.data;
                const expectedChar = currentText[charIndex];

                let isCorrect;
                if (isCaseSensitive) {
                    isCorrect = (typedChar === expectedChar);
                } else {
                    isCorrect = (typedChar?.toLowerCase() === expectedChar?.toLowerCase());
                }
                typedCharsCorrectness[charIndex] = isCorrect;
                
                charIndex++; // Move to the next character
            }

            // Update words typed count (based on words in the input value)
            const currentInputValue = textInput.value.trim();
            if (currentInputValue) {
                wordsTypedCount = currentInputValue.split(/\s+/).length;
            } else {
                wordsTypedCount = 0;
            }
            wordsTypedDisplay.textContent = wordsTypedCount;

            // Update the display with current progress
            updateTextDisplay();

            // Check if the test is completed by typing all characters
            if (charIndex === currentText.length) {
                endTest();
            }
        }

        /**
         * Ends the typing test and calculates results.
         */
        function endTest() {
            if (!isTestRunning) return;

            isTestRunning = false;
            endTime = new Date().getTime();
            clearInterval(timerInterval);
            textInput.disabled = true;
            startButton.textContent = 'Restart Test';
            startButton.disabled = false;
            printButton.disabled = false;

            // Re-enable options
            testDurationSelect.disabled = false;
            textCategorySelect.disabled = false;
            caseSensitiveCheckbox.disabled = false; // Enable case sensitive checkbox after test

            const timeTakenSeconds = (endTime - startTime) / 1000;
            const timeTakenMinutes = timeTakenSeconds / 60;

            let actualCorrectChars = 0;
            let actualErrors = 0;
            
            // Calculate final errors and correct characters based on the final typed content
            // Only count characters that were actually typed (up to charIndex)
            for (let i = 0; i < charIndex; i++) {
                // Ensure both characters exist for comparison
                const typedChar = textInput.value[i];
                const expectedChar = currentText[i];

                if (typedChar !== undefined && expectedChar !== undefined) {
                    if (isCaseSensitive) {
                        if (typedChar === expectedChar) {
                            actualCorrectChars++;
                        } else {
                            actualErrors++;
                        }
                    } else {
                        if (typedChar.toLowerCase() === expectedChar.toLowerCase()) {
                            actualCorrectChars++;
                        } else {
                            actualErrors++;
                        }
                    }
                } else if (expectedChar !== undefined) {
                    // If user typed less than expected up to charIndex, count as error
                    actualErrors++;
                }
            }

            finalWPM = (actualCorrectChars / 5) / timeTakenMinutes;
            finalWPM = timeTakenMinutes > 0 ? Math.max(0, Math.round(finalWPM)) : 0;

            // Accuracy based on (correctly typed chars / total chars attempted)
            finalAccuracy = charIndex > 0 ? Math.max(0, Math.round((actualCorrectChars / charIndex) * 100)) : 0;

            finalErrors = actualErrors;
            finalTime = Math.round(timeTakenSeconds);
            finalWordsTyped = wordsTypedCount;
            finalScore = Math.round(finalWPM * (finalAccuracy / 100));

            wpmDisplay.textContent = finalWPM;
            accuracyDisplay.textContent = `${finalAccuracy}%`;
            errorsDisplay.textContent = finalErrors;
            timerDisplay.textContent = finalTime;
            wordsTypedDisplay.textContent = finalWordsTyped;
            scoreDisplay.textContent = finalScore;

            // Remove highlight from current char
            currentCharSpan.classList.remove('highlight-current');

            // Final update to display all typed text with correct/incorrect highlighting
            let finalTypedHtml = '';
            for (let i = 0; i < charIndex; i++) {
                const typedChar = textInput.value[i];
                const expectedChar = currentText[i];
                let className = '';

                if (typedChar !== undefined && expectedChar !== undefined) {
                    let isCharCorrect;
                    if (isCaseSensitive) {
                        isCharCorrect = (typedChar === expectedChar);
                    } else {
                        isCharCorrect = (typedChar.toLowerCase() === expectedChar.toLowerCase());
                    }

                    if (isCharCorrect) {
                        className = 'correct';
                    } else {
                        className = 'incorrect';
                    }
                } else {
                    // If typedChar is undefined, it means user hasn't typed up to this point
                    // or backspaced. We show the expected character with an error highlight.
                    className = 'incorrect';
                }
                finalTypedHtml += `<span class="${className}">${currentText[i]}</span>`; // Display the expected char in color
            }
            typedTextSpan.innerHTML = finalTypedHtml;

            currentCharSpan.textContent = '';
            remainingTextSpan.textContent = '';
        }

        /**
         * Generates and prints the test results.
         */
        function printResults() {
            const printContent = `
                <div style="font-family: Arial, sans-serif; padding: 20px; text-align: center;">
                    <h1 style="color: #2563eb;">Typing Test Results</h1>
                    <p style="font-size: 18px;">Test Duration: ${selectedDuration === 0 ? 'Full Text' : selectedDuration + ' seconds'}</p>
                    <p style="font-size: 18px;">Text Category: ${textCategorySelect.value.charAt(0).toUpperCase() + textCategorySelect.value.slice(1)}</p>
                    <p style="font-size: 18px;">Case Sensitive: ${isCaseSensitive ? 'Yes' : 'No'}</p>
                    <hr style="margin: 20px 0; border: 0; border-top: 1px solid #ccc;">
                    <h2 style="color: #1d4ed8; margin-bottom: 10px;">Your Performance:</h2>
                    <table style="width: 80%; margin: 0 auto; border-collapse: collapse;">
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: left; font-weight: bold;">WPM (Words Per Minute):</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${finalWPM}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: left; font-weight: bold;">Accuracy:</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${finalAccuracy}%</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: left; font-weight: bold;">Errors:</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${finalErrors}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: left; font-weight: bold;">Time Taken:</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${finalTime} seconds</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: left; font-weight: bold;">Words Typed:</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${finalWordsTyped}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: left; font-weight: bold;">Score:</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${finalScore}</td>
                        </tr>
                    </table>
                </div>
            `;

            // Open a new window for printing
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            printWindow.document.write(printContent);
            printWindow.document.close();

            // Wait for content to render, then print
            printWindow.onload = function() {
                printWindow.print();
                printWindow.close();
            };
        }

        // Event Listeners
        startButton.addEventListener('click', startTest);
        resetButton.addEventListener('click', initializeTest);
        printButton.addEventListener('click', printResults);
        textInput.addEventListener('input', handleInput);
        testDurationSelect.addEventListener('change', initializeTest);
        textCategorySelect.addEventListener('change', initializeTest); 
        caseSensitiveCheckbox.addEventListener('change', initializeTest); // New event listener

        // Initialize the test when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeTest(); 
        });
    </script>
</body>
</html>
